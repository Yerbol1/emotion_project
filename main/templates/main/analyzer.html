<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>–ö”©“£—ñ–ª-–∫“Ø–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- –°–µ–Ω—ñ“£ –¥–∏–∑–∞–π–Ω —Å—Ç–∏–ª—ñ“£ –µ—à ”©–∑–≥–µ—Ä—ñ—Å—Å—ñ–∑ “õ–∞–ª–¥—ã—Ä—ã–ª–¥—ã --- */
    body {
      background: radial-gradient(circle at top right, #1e3a8a, #111827);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 24px;
    }
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 20px;
      width: 380px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .input-field {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 10px;
      color: #fff;
      width: 100%;
      margin-bottom: 12px;
      outline: none;
    }
    .btn {
      background: linear-gradient(to right, #2563eb, #1e40af);
      border: none;
      padding: 10px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
    .scanner {
      width: 320px;
      height: 240px;
      border: 3px solid #22d3ee;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      margin: 10px auto;
    }
    video, canvas {
      width: 320px;
      height: 240px;
      border-radius: 8px;
      display: block;
    }
    .indicator {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      border: 3px dashed rgba(34,211,238,0.6);
      width: 140px;
      height: 140px;
      border-radius: 8px;
      pointer-events: none;
      box-shadow: 0 0 30px rgba(34,211,238,0.06);
    }
    .result-box {
      margin-top: 12px;
      text-align: left;
      color: #e6eef8;
    }
    .label { color: #a7f3d0; font-weight:600; }
  </style>
</head>
<body>
  <div class="card text-center">
    <h1 class="text-3xl font-bold mb-5 text-cyan-400">üß† –ö”©“£—ñ–ª-–∫“Ø–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã</h1>

    <input id="fullName" class="input-field" type="text" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑ (–º—ã—Å–∞–ª—ã: –ï—Ä–±–æ–ª –°–∞–∏–π—Ñ—É–ª–ª–∞–µ–≤)" />

    <select id="ageGroup" class="input-field">
      <option value="">–ñ–∞—Å –∞—Ä–∞–ª—ã“ì—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑</option>
      <option value="5‚Äì8 –∂–∞—Å">5‚Äì8 –∂–∞—Å</option>
      <option value="8‚Äì12 –∂–∞—Å">8‚Äì12 –∂–∞—Å</option>
      <option value="12‚Äì17 –∂–∞—Å">12‚Äì17 –∂–∞—Å</option>
    </select>

    <button id="startBtn" class="btn mb-3">üé• –ê–Ω–∞–ª–∏–∑ –∂–∞—Å–∞—É</button>

    <div id="scanner" class="scanner hidden">
      <video id="video" autoplay playsinline></video>
      <div class="indicator"></div>
    </div>

    <div id="status" class="mt-2 text-sm text-cyan-200"></div>

    <div id="result" class="result-box"></div>
  </div>

<script>
/*
  Frontend logic:
  - –∞—Ç—ã-–∂”©–Ω –∂”ô–Ω–µ –∂–∞—Å —Ç–∞“£–¥–∞–ª—Å–∞ "–ê–Ω–∞–ª–∏–∑ –∂–∞—Å–∞—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å“õ–∞–Ω–¥–∞ –∫–∞–º–µ—Ä–∞ –∞—à—ã–ª–∞–¥—ã
  - 5 —Å–µ–∫—É–Ω–¥ –±–æ–π—ã –∫–∞–¥—Ä–ª–∞—Ä –∞–ª—ã–Ω–∞–¥—ã (”ô–¥–µ—Ç—Ç–µ ~700ms –∏–Ω—Ç–µ—Ä–≤–∞–ª)
  - –∫–∞–¥—Ä–ª–∞—Ä base64 —Ç—ñ–∑—ñ–º—ñ —Ä–µ—Ç—ñ–Ω–¥–µ /analyze/ endpoint-“õ–∞ –∂—ñ–±–µ—Ä—ñ–ª–µ–¥—ñ (POST JSON)
  - —Å–µ—Ä–≤–µ—Ä DeepFace –∞—Ä“õ—ã–ª—ã ”©“£–¥–µ–π–¥—ñ, –æ—Ä—Ç–∞—à–∞ –∏–Ω–¥–µ–∫—Å, –¥–æ–º–∏–Ω–∞–Ω—Ç —ç–º–æ—Ü–∏—è –∂”ô–Ω–µ –∫–µ“£–µ—Å “õ–∞–π—Ç–∞—Ä–∞–¥—ã
  - –∂–∞—É–∞–ø –∫”©—Ä—Å–µ—Ç—ñ–ª–µ–¥—ñ
  - CSRF cookie-–¥–∞–Ω –∞–ª—ã–Ω–∞–¥—ã (Django “Ø—à—ñ–Ω)
*/

const startBtn = document.getElementById('startBtn');
const video = document.getElementById('video');
const scanner = document.getElementById('scanner');
const status = document.getElementById('status');
const result = document.getElementById('result');

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const c = cookie.trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

startBtn.addEventListener('click', async () => {
  const fullName = document.getElementById('fullName').value.trim();
  const ageGroup = document.getElementById('ageGroup').value;

  if (!fullName) { alert('–ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑'); return; }
  if (!ageGroup) { alert('–ñ–∞—Å –∞—Ä–∞–ª—ã“ì—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑'); return; }

  // UI
  result.innerHTML = '';
  status.innerText = '–ö–∞–º–µ—Ä–∞ –∞—à—ã–ª—É–¥–∞ ‚Äî –∫”©–∑–≥–µ —Ñ–æ–∫—É—Å –æ—Ä–Ω–∞–ª–∞—Å—Ç—ã—Ä—ã“£—ã–∑ (5 —Å–µ–∫)...';
  scanner.classList.remove('hidden');

  // –°—É—Ä–µ—Ç—Ç–µ—Ä –∂–∏–Ω–∞—É
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    video.srcObject = stream;
  } catch (err) {
    scanner.classList.add('hidden');
    status.innerText = '–ö–∞–º–µ—Ä–∞“ì–∞ “õ–∞—Ç—ã–Ω–∞—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã: ' + err.message;
    return;
  }

  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');

  const frames = [];
  const intervalMs = 700; // ”ô—Ä 700ms –∫–∞–¥—Ä –∞–ª—É
  const durationMs = 5000; // 5 —Å–µ–∫—É–Ω–¥
  status.innerText = '–°–∫–∞–Ω–µ—Ä–ª–µ—É: 0%';

  let elapsed = 0;
  const start = Date.now();

  const iv = setInterval(() => {
    try {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      frames.push(dataUrl);
    } catch (e) {
      console.error('capture error', e);
    }
    elapsed = Date.now() - start;
    const pct = Math.min(100, Math.round((elapsed / durationMs) * 100));
    status.innerText = `–°–∫–∞–Ω–µ—Ä–ª–µ—É: ${pct}%`;
  }, intervalMs);

  // –∞—è“õ—Ç–∞—É —Ç–∞–π–º–µ—Ä—ñ
  setTimeout(async () => {
    clearInterval(iv);
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
    }
    scanner.classList.add('hidden');
    status.innerText = '–ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–≤–µ—Ä–≥–µ –∂—ñ–±–µ—Ä—ñ–ª—É–¥–µ...';

    // POST JSON: full_name, age_group, frames[]
    try {
      const resp = await fetch('/analyze/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          full_name: fullName,
          age_group: ageGroup,
          frames: frames
        })
      });

      if (!resp.ok) {
        const t = await resp.text();
        throw new Error(`–°–µ—Ä–≤–µ—Ä “õ–∞—Ç–µ—Å—ñ: ${resp.status} ${t}`);
      }

      const data = await resp.json();

      // Show result
      status.innerText = '–ê–Ω–∞–ª–∏–∑ –∞—è“õ—Ç–∞–ª–¥—ã';
      result.innerHTML = `
        <div class="p-3 rounded-md" style="background: rgba(0,0,0,0.25);">
          <div style="color:#fef3c7;font-weight:700;margin-bottom:6px;">üîé –ù”ô—Ç–∏–∂–µ</div>
          <div><span class="label">–ê—Ç—ã-–∂”©–Ω:</span> ${escapeHtml(fullName)}</div>
          <div><span class="label">–ñ–∞—Å –∞—Ä–∞–ª—ã“ì—ã:</span> ${escapeHtml(ageGroup)}</div>
          <div style="margin-top:8px;"><span class="label">–≠–º–æ—Ü–∏—è (–¥–æ–º–∏–Ω–∞–Ω—Ç):</span> ${escapeHtml(data.emotion)}</div>
          <div><span class="label">–û—Ä—Ç–∞—à–∞ –∏–Ω–¥–µ–∫—Å (–ø–∞–π—ã–∑):</span> ${escapeHtml(data.avg_score)}</div>
          <hr style="margin:8px 0; border-color: rgba(255,255,255,0.08)" />
          <div style="color:#e6eef8; white-space:pre-wrap;">${escapeHtml(data.advice)}</div>
        </div>
      `;

    } catch (err) {
      console.error(err);
      status.innerText = '–ê–Ω–∞–ª–∏–∑ –±–∞—Ä—ã—Å—ã–Ω–¥–∞ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã: ' + err.message;
      result.innerHTML = `<div style="color:#ffd7d7">“ö–∞—Ç–µ: ${escapeHtml(err.message)}</div>`;
    }
  }, durationMs);
});

function escapeHtml(s) {
  // “ö–∞–Ω–¥–∞–π –¥–∞ –±—ñ—Ä –Ω–µ string –µ–º–µ—Å –º”ô–Ω –∫–µ–ª—Å–µ, –æ–Ω—ã string-–∫–µ –∞–π–Ω–∞–ª–¥—ã—Ä–∞–º—ã–∑
  if (s === null || s === undefined) return '';
  s = String(s);
  // “í–∞–ª–∞–º–¥—ã“õ –∞—É—ã—Å—Ç—ã—Ä—É “Ø—à—ñ–Ω —Ä–µ–≥–µ–∫—Å—Ç—ñ “õ–æ–ª–¥–∞–Ω–∞–º—ã–∑ (–±–∞—Ä–ª—ã“õ –æ—Ä—ã–Ω–¥–∞–ª—ã–º–¥–∞—Ä—ã–Ω–∞)
  return s
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

</script>
</body>
</html>
